  <!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>TP Web3D</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <script src="https://gftruj.github.io/webzamples/aframe/controls/oculus-thumbstick-controls.js"></script>

  </head>
  
  <body style="margin:0; overflow:hidden;">
    
    <a-scene shadow="type: pcfsoft" vr-mode-ui="enabled: true">

      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
      <a-entity
        light="type: directional;
               intensity: 1;
               castShadow: true;
               shadowBias: -0.0005;
               shadowMapWidth: 2048;
               shadowMapHeight: 2048;
               shadowCameraLeft: -8;
               shadowCameraRight: 8;
               shadowCameraTop: 8;
               shadowCameraBottom: -8;
               shadowCameraNear: 0.5;
               shadowCameraFar: 50"
               position="5 10 5">
      </a-entity>
            
      <a-plane position="0 0 0" rotation="-90 0 0" width="40" height="40" color="green" static-body shadow="receive: true"></a-plane>
      
      <a-box id="cube" 
             color="red" 
             depth="3" height="3" width="3" 
             position="4 1.5 -3"
             rotation="0 40 0"
             shadow="cast: true; receive: true">
      </a-box>

      <a-sphere id="bouboule"
                color="blue"
                radius="1.2"
                position="-1 1.2 6"
                shadow="cast: true; receive: true">
      </a-sphere>

      <a-cylinder id="mnms"
                  position="0 0.75 -2"
                  radius="0.5"
                  height="1.5"
                  color="#FFC65D"
                  shadow="cast: true; receive: true">
      </a-cylinder>

      <a-entity id="rig" position="0 1.6 0"
                move-with-left-stick
                turn-with-right-stick>
        <a-entity camera look-controls></a-entity>
        <a-entity hand-controls="hand: left" meta-touch-controls="hand: left"></a-entity>
        <a-entity hand-controls="hand: right" meta-touch-controls="hand: right"></a-entity>
      </a-entity>
      
      <script>
        AFRAME.registerComponent('move-with-left-stick', {
          schema: {speed: {type: 'number', default: 0.07}},
          tick: function () {
            const leftHand = document.querySelector('[hand-controls="hand: left"]');
            if (!leftHand || !leftHand.components['tracked-controls']) return;
            const gamepad = leftHand.components['tracked-controls'].controller;
            if (!gamepad || !gamepad.axes || gamepad.axes.length < 2) return;
            const x = gamepad.axes[0]; // left stick horz
            const y = gamepad.axes[1]; // left stick vert
            if (Math.abs(x) < 0.1 && Math.abs(y) < 0.1) return;
            
            const rig = this.el;
            const camera = rig.querySelector('[camera]');
            if (!camera) return;
            const rotation = camera.object3D.rotation.y;
            
            // Déplacement selon orientation Y de la caméra
            const dx = -y * Math.sin(rotation) * this.data.speed + x * Math.cos(rotation) * this.data.speed;
            const dz = -y * Math.cos(rotation) * this.data.speed - x * Math.sin(rotation) * this.data.speed;
            rig.object3D.position.x += dx;
            rig.object3D.position.z += dz;
          }
        });
        
        AFRAME.registerComponent('turn-with-right-stick', {
          schema: {speed: {type: 'number', default: 2.0}},
          tick: function () {
            const rightHand = document.querySelector('[hand-controls="hand: right"]');
            if (!rightHand || !rightHand.components['tracked-controls']) return;
            const gamepad = rightHand.components['tracked-controls'].controller;
            if (!gamepad || !gamepad.axes || gamepad.axes.length < 4) return;
            const x = gamepad.axes[2]; // right stick horz
            if (Math.abs(x) < 0.2) return;
            // Rotation yaw
            this.el.object3D.rotation.y -= x * this.data.speed * 0.03;
          }
        });
      </script>

      
      <!--<a-entity id="rig" oculus-thumbstick-controls>
        <a-entity camera look-controls wasm-controls></a-entity>
        <a-entity oculus-touch-controls="hand: left"></a-entity>
        <a-entity oculus-touch-controls="hand: right"></a-entity>
      </a-entity>
      
      <script>
        AFRAME.registerComponent('thumbstick-turn', {
          schema: {speed: {type: "number", default: 2.0}},
          tick: function () {
            var rightHand = document.querySelector('[hand-controls="hand: right"]');
            if (!rightHand || !rightHand.components['tracked-controls']) return;
            var gamepad = rightHand.components['tracked-controls'].controller;
            // Sur Quest/Meta/Oculus : axes[2] = horizontal du stick droit
            if (!gamepad || !gamepad.axes || gamepad.axes.length < 4) return;
            var x = gamepad.axes[2];
            if (Math.abs(x) > 0.20) {
              this.el.object3D.rotation.y -= x * this.data.speed * 0.03;
            }
          }
        });
      </script>-->

    </a-scene>
  </body>
</html>
